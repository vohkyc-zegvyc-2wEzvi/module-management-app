<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>品格</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        background: '#F9FAFB',
                        card: '#FFFFFF',
                        section: '#EFF6FF',
                        product: '#FEF3C7',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    screens: {
                        'xs': '320px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .dashed-border {
                border: 2px dashed #D1D5DB;
            }
            .card-shadow {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .transition-smooth {
                transition: all 0.3s ease;
            }
            .image-viewer-active {
                display: flex !important;
            }
            .selected {
                border-color: #4F46E5;
                background-color: #F5F3FF;
            }
        }
        
        /* 适配iPad */
        @media (min-width: 768px) and (max-width: 1024px) {
            .responsive-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* 适配手机 */
        @media (max-width: 767px) {
            .responsive-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="bg-background font-sans text-gray-800 min-h-screen">
    <!-- 登录/注册页面 -->
    <div id="login-page" class="page active min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-2">品格</h1>
            <p class="text-gray-500 text-center mb-8">欢迎使用内容管理工具</p>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">昵称</label>
                    <input type="text" id="username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           placeholder="请输入昵称">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           placeholder="请输入密码">
                </div>
                
                <button id="login-btn" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-smooth font-medium">
                    登录 / 注册
                </button>
                
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">或</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">查看现有内容</p>
                    <button id="view-mode-btn" class="w-full border-2 border-primary text-primary py-3 rounded-lg hover:bg-primary/5 transition-smooth font-medium">
                        进入查看模式
                    </button>
                </div>
            </div>
            
            <!-- 错误提示 -->
            <div id="login-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm hidden">
                <i class="fa fa-exclamation-circle mr-2"></i>
                <span id="error-message">请输入正确密码</span>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-8">
                首次使用将自动注册，昵称作为唯一账号标识
            </p>
        </div>
    </div>
    
    <!-- 主程序页面 -->
    <div id="app-container" class="hidden">
        <!-- 首页 -->
        <div id="home-page" class="page active min-h-screen">
            <!-- 顶部导航 -->
            <nav class="py-4 px-6 border-b border-gray-200 bg-white flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center">
                    <button id="logout-btn" class="text-gray-600 mr-3">
                        <i class="fa fa-sign-out text-lg"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">模块管理</h1>
                </div>
                <div class="flex space-x-4">
                    <button id="manage-modules" class="text-primary">
                        <i class="fa fa-cog"></i>
                        <span class="ml-1 hidden sm:inline">管理</span>
                    </button>
                </div>
            </nav>
            
            <!-- 管理模式操作栏 -->
            <div id="management-bar" class="py-3 px-6 border-b border-gray-200 bg-white flex justify-between items-center hidden">
                <span class="text-sm text-gray-600">已选择 <span id="selected-count">0</span> 项</span>
                <div class="flex space-x-3">
                    <button id="cancel-management" class="text-gray-600 text-sm">
                        取消
                    </button>
                    <button id="delete-selected" class="text-red-500 text-sm">
                        <i class="fa fa-trash mr-1"></i>删除
                    </button>
                </div>
            </div>
            
            <!-- 模块列表 -->
            <div class="p-4 md:p-6">
                <div id="modules-container" class="responsive-grid gap-4 md:gap-6">
                    <!-- 添加模块的虚线框 -->
                    <div id="add-module-card" class="dashed-border rounded-xl p-4 flex flex-col items-center justify-center h-40 cursor-pointer hover:bg-gray-50 transition-smooth">
                        <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center mb-3">
                            <i class="fa fa-plus text-gray-500 text-xl"></i>
                        </div>
                        <p class="text-gray-500 text-sm">添加新模块</p>
                    </div>
                    <!-- 模块会动态添加到这里 -->
                </div>
            </div>
            
            <!-- 底部提示 -->
            <div class="fixed bottom-4 left-0 right-0 text-center text-gray-400 text-xs px-4">
                <div class="inline-block bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full card-shadow">
                    <span id="home-tips">点击"+"添加新模块，点击模块进入详情</span>
                </div>
            </div>
        </div>
        
        <!-- 详情页面 -->
        <div id="detail-page" class="page hidden min-h-screen">
            <!-- 顶部导航 -->
            <nav class="py-4 px-6 border-b border-gray-200 bg-white flex justify-between items-center sticky top-0 z-10">
                <button id="back-to-home" class="text-gray-600">
                    <i class="fa fa-arrow-left text-lg"></i>
                </button>
                <h1 id="detail-module-name" class="text-xl font-bold text-gray-800 truncate px-2">模块名称</h1>
                <button id="add-section" class="text-primary">
                    <i class="fa fa-plus text-lg"></i>
                </button>
            </nav>
            
            <!-- 大版块容器 -->
            <div id="sections-container" class="p-4 md:p-6 space-y-4 md:space-y-6 max-h-[calc(100vh-60px)] overflow-y-auto">
                <!-- 大版块会动态添加到这里 -->
            </div>
        </div>
        
        <!-- 产品编辑页面 -->
        <div id="product-edit-page" class="page hidden min-h-screen">
            <!-- 顶部导航 -->
            <nav class="py-4 px-6 border-b border-gray-200 bg-white flex justify-between items-center sticky top-0 z-10">
                <button id="back-to-detail" class="text-gray-600">
                    <i class="fa fa-arrow-left text-lg"></i>
                </button>
                <h1 id="edit-product-name" class="text-xl font-bold text-gray-800 truncate px-2">产品名称</h1>
                <button id="save-edit" class="text-primary font-medium">保存</button>
            </nav>
            
            <!-- 编辑内容 -->
            <div class="p-4 md:p-6 max-h-[calc(100vh-60px)] overflow-y-auto">
                <!-- 产品描述 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">产品描述</label>
                    <textarea id="product-description" rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"
                              placeholder="请输入产品描述..."></textarea>
                </div>
                
                <!-- 最近修改时间 -->
                <div class="text-sm text-gray-500 mb-6" id="last-modified">
                    修改于刚刚
                </div>
                
                <!-- 细节展示图片区域 -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium text-gray-800">细节展示 <span class="text-sm text-gray-500">(最多3张)</span></h3>
                        <span class="text-sm text-gray-500" id="detail-image-count">0/3</span>
                    </div>
                    
                    <div id="detail-images-container" class="grid grid-cols-3 gap-3 min-h-[100px]">
                        <!-- 添加细节图片按钮 -->
                        <div id="add-detail-image-btn" class="dashed-border rounded-lg p-4 flex flex-col items-center justify-center h-28 cursor-pointer hover:bg-gray-50 transition-smooth">
                            <i class="fa fa-plus text-gray-400 text-xl"></i>
                            <p class="text-xs text-gray-400 mt-2">添加</p>
                        </div>
                        <!-- 细节图片会动态添加到这里 -->
                    </div>
                </div>
                
                <!-- 图片展示区域 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium text-gray-800">图片展示 <span class="text-sm text-gray-500">(最多6张)</span></h3>
                        <span class="text-sm text-gray-500" id="gallery-image-count">0/6</span>
                    </div>
                    
                    <div id="gallery-images-container" class="grid grid-cols-3 gap-3 min-h-[120px]">
                        <!-- 添加图片按钮 -->
                        <div id="add-gallery-image-btn" class="dashed-border rounded-lg p-4 flex flex-col items-center justify-center h-32 cursor-pointer hover:bg-gray-50 transition-smooth">
                            <i class="fa fa-plus text-gray-400 text-xl"></i>
                            <p class="text-xs text-gray-400 mt-2">添加图片</p>
                        </div>
                        <!-- 图片会动态添加到这里 -->
                    </div>
                    
                    <!-- 图片上传控件 (隐藏) -->
                    <input type="file" id="detail-image-upload" accept="image/*" multiple hidden>
                    <input type="file" id="gallery-image-upload" accept="image/*" multiple hidden>
                    
                    <!-- 批量上传提示 -->
                    <div class="text-xs text-gray-500 text-center mt-6">
                        支持批量上传，单张图片不超过1MB
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图片查看器 -->
        <div id="image-viewer" class="fixed inset-0 bg-black z-50 hidden items-center justify-center">
            <button id="close-image-viewer" class="absolute top-6 right-6 text-white text-3xl">
                <i class="fa fa-times"></i>
            </button>
            <button id="prev-image" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-4xl">
                <i class="fa fa-chevron-left"></i>
            </button>
            <div id="image-viewer-container" class="max-w-full max-h-screen flex items-center justify-center px-4">
                <img id="current-image" src="" alt="图片预览" class="max-w-full max-h-[80vh] object-contain">
            </div>
            <button id="next-image" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-4xl">
                <i class="fa fa-chevron-right"></i>
            </button>
            <div id="image-counter" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-white bg-black/50 px-4 py-2 rounded-full text-sm">
                1/3
            </div>
        </div>
        
        <!-- 模态框：添加/编辑模块 -->
        <div id="module-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md mx-4">
                <h3 class="text-lg font-bold mb-6">添加新模块</h3>
                <div class="mb-6">
                    <label for="module-name" class="block text-sm font-medium text-gray-700 mb-2">模块名称</label>
                    <input type="text" id="module-name" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           placeholder="请输入模块名称">
                </div>
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">模块封面</label>
                    <div id="module-upload-area" class="dashed-border rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition-smooth">
                        <img id="module-preview" src="" alt="模块封面预览" class="w-full h-40 object-cover rounded-lg mb-4 hidden">
                        <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-3"></i>
                        <p class="text-sm text-gray-600 mb-2">点击上传封面图片</p>
                        <p class="text-xs text-gray-500">建议尺寸：300×200像素</p>
                        <input type="file" id="module-image-upload" accept="image/*" hidden>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-module" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                    <button id="save-module" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90">确定</button>
                </div>
            </div>
        </div>
        
        <!-- 模态框：添加/编辑大版块 -->
        <div id="section-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md mx-4">
                <h3 id="section-modal-title" class="text-lg font-bold mb-6">添加大版块</h3>
                <div class="mb-8">
                    <label for="section-name" class="block text-sm font-medium text-gray-700 mb-2">版块名称</label>
                    <input type="text" id="section-name" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           placeholder="请输入版块名称">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-section" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                    <button id="save-section" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90">确定</button>
                </div>
            </div>
        </div>
        
        <!-- 模态框：添加/编辑产品 -->
        <div id="product-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md mx-4">
                <h3 id="product-modal-title" class="text-lg font-bold mb-6">添加产品</h3>
                <div class="mb-8">
                    <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">产品名称</label>
                    <input type="text" id="product-name" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           placeholder="请输入产品名称">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-product" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                    <button id="save-product" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90">确定</button>
                </div>
            </div>
        </div>
        
        <!-- 确认删除模态框 -->
        <div id="confirm-delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md mx-4">
                <h3 class="text-lg font-bold mb-4">确认删除</h3>
                <p class="text-gray-600 mb-8" id="delete-confirmation-text">您确定要删除此项吗？此操作无法撤销。</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                    <button id="confirm-delete" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">删除</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 数据存储与云端接口 ====================
        const STORAGE_KEY = 'module_manager_data';
        const USER_KEY = 'module_manager_user';
        
        // 云端接口预留 (GitHub, Firebase, 或其他云服务)
        const CloudAPI = {
            // 保存数据到云端
            async saveToCloud(userId, data) {
                try {
                    // 预留接口：替换为实际的云端API调用
                    // 示例：await fetch('https://api.your-cloud.com/save', {...})
                    console.log('保存数据到云端:', { userId, data });
                    localStorage.setItem(`${STORAGE_KEY}_${userId}`, JSON.stringify(data));
                    return { success: true };
                } catch (error) {
                    console.error('云端保存失败:', error);
                    return { success: false, error };
                }
            },
            
            // 从云端加载数据
            async loadFromCloud(userId) {
                try {
                    // 预留接口：替换为实际的云端API调用
                    // 示例：const response = await fetch(`https://api.your-cloud.com/load/${userId}`)
                    const data = localStorage.getItem(`${STORAGE_KEY}_${userId}`);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('云端加载失败:', error);
                    return null;
                }
            },
            
            // 同步数据
            async syncData(userId, data) {
                // 这里可以实现双向同步逻辑
                const cloudData = await this.loadFromCloud(userId);
                if (cloudData) {
                    // 合并本地和云端数据（根据时间戳）
                    return this.mergeData(data, cloudData);
                }
                return data;
            },
            
            // 数据合并策略
            mergeData(localData, cloudData) {
                // 简单的合并策略：以最新修改时间为准
                // 实际项目中可以实现更复杂的冲突解决
                return {
                    modules: [...localData.modules, ...cloudData.modules]
                        .filter((v, i, a) => a.findIndex(t => t.id === v.id) === i),
                    nextId: Math.max(localData.nextId, cloudData.nextId)
                };
            }
        };
        
        // 应用状态管理
        const AppState = {
            // 用户信息
            currentUser: null,
            isEditMode: false,
            
            // 应用数据
            data: {
                modules: [],
                nextId: 1
            },
            
            // 当前上下文
            currentModule: null,
            currentSection: null,
            currentProduct: null,
            
            // 选择状态
            selectedModules: [],
            isManagingModules: false,
            
            // 图片查看器
            currentImageIndex: 0,
            currentImageGroup: 'detail'
        };
        
        // ==================== 用户认证系统 ====================
        const AuthSystem = {
            // 注册新用户
            async register(username, password) {
                const userData = {
                    username,
                    password: this.hashPassword(password),
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                // 保存用户信息
                localStorage.setItem(USER_KEY, JSON.stringify(userData));
                
                // 初始化用户数据
                const initialData = {
                    modules: [],
                    nextId: 1
                };
                
                await CloudAPI.saveToCloud(username, initialData);
                return userData;
            },
            
            // 登录
            async login(username, password) {
                const userData = JSON.parse(localStorage.getItem(USER_KEY));
                
                if (!userData) {
                    // 新用户，自动注册
                    return await this.register(username, password);
                }
                
                // 验证密码
                if (userData.username === username && 
                    userData.password === this.hashPassword(password)) {
                    // 更新最后登录时间
                    userData.lastLogin = new Date().toISOString();
                    localStorage.setItem(USER_KEY, JSON.stringify(userData));
                    return userData;
                }
                
                return null;
            },
            
            // 简单的密码哈希（实际项目中使用更安全的哈希算法）
            hashPassword(password) {
                return btoa(password + 'salt'); // 仅为示例
            },
            
            // 检查登录状态
            checkLoginStatus() {
                const userData = JSON.parse(localStorage.getItem(USER_KEY));
                if (userData) {
                    return userData;
                }
                return null;
            },
            
            // 登出
            logout() {
                localStorage.removeItem(USER_KEY);
                AppState.currentUser = null;
                AppState.isEditMode = false;
            }
        };
        
        // ==================== 数据持久化 ====================
        const DataManager = {
            // 保存数据
            async saveData() {
                if (!AppState.currentUser) return;
                
                // 保存到本地
                localStorage.setItem(`${STORAGE_KEY}_${AppState.currentUser.username}`, 
                    JSON.stringify(AppState.data));
                
                // 保存到云端
                if (AppState.isEditMode) {
                    await CloudAPI.saveToCloud(AppState.currentUser.username, AppState.data);
                }
            },
            
            // 加载数据
            async loadData(username) {
                // 尝试从云端同步
                if (AppState.isEditMode) {
                    const cloudData = await CloudAPI.syncData(username, AppState.data);
                    if (cloudData) {
                        AppState.data = cloudData;
                    }
                } else {
                    // 查看模式只从本地加载
                    const localData = localStorage.getItem(`${STORAGE_KEY}_${username}`);
                    if (localData) {
                        AppState.data = JSON.parse(localData);
                    }
                }
                
                return AppState.data;
            },
            
            // 自动保存
            autoSave() {
                if (AppState.isEditMode) {
                    this.saveData();
                }
            }
        };
        
        // ==================== DOM 操作与渲染 ====================
        const UIManager = {
            // 切换页面
            showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.add('hidden');
                });
                document.getElementById(pageId).classList.remove('hidden');
                
                // 退出管理模式
                if (pageId !== 'home-page') {
                    this.exitModuleManagementMode();
                }
            },
            
            // 显示模态框
            showModal(modalId) {
                document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                    modal.classList.add('hidden');
                });
                document.getElementById(modalId).classList.remove('hidden');
            },
            
            // 隐藏所有模态框
            hideAllModals() {
                document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                    modal.classList.add('hidden');
                });
            },
            
            // 进入模块管理模式
            enterModuleManagementMode() {
                AppState.isManagingModules = true;
                AppState.selectedModules = [];
                
                document.getElementById('management-bar').classList.remove('hidden');
                document.getElementById('manage-modules').innerHTML = 
                    '<i class="fa fa-cog"></i><span class="ml-1 hidden sm:inline">管理</span>';
                document.getElementById('home-tips').textContent = '点击模块进行选择';
                document.getElementById('add-module-card').style.pointerEvents = 'none';
                document.getElementById('add-module-card').classList.add('opacity-50');
                
                // 添加选择样式
                document.querySelectorAll('.module-card').forEach(card => {
                    if (!card.querySelector('.select-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'select-overlay absolute inset-0 bg-white/50 hidden';
                        card.appendChild(overlay);
                        
                        const checkmark = document.createElement('div');
                        checkmark.className = 'absolute top-3 right-3 w-6 h-6 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center hidden';
                        checkmark.innerHTML = '<i class="fa fa-check text-primary text-xs"></i>';
                        card.appendChild(checkmark);
                    }
                });
                
                this.updateSelectedCount();
            },
            
            // 退出模块管理模式
            exitModuleManagementMode() {
                AppState.isManagingModules = false;
                AppState.selectedModules = [];
                
                document.getElementById('management-bar').classList.add('hidden');
                document.getElementById('home-tips').textContent = '点击"+"添加新模块，点击模块进入详情';
                document.getElementById('add-module-card').style.pointerEvents = 'auto';
                document.getElementById('add-module-card').classList.remove('opacity-50');
                
                // 移除选择样式
                document.querySelectorAll('.module-card').forEach(card => {
                    const overlay = card.querySelector('.select-overlay');
                    const checkmark = card.querySelector('.absolute.top-3');
                    if (overlay) overlay.classList.add('hidden');
                    if (checkmark) checkmark.classList.add('hidden');
                });
            },
            
            // 切换模块选择状态
            toggleModuleSelection(moduleId) {
                const index = AppState.selectedModules.indexOf(moduleId);
                if (index === -1) {
                    AppState.selectedModules.push(moduleId);
                } else {
                    AppState.selectedModules.splice(index, 1);
                }
                
                // 更新UI
                const card = document.querySelector(`.module-card[data-id="${moduleId}"]`);
                if (card) {
                    const overlay = card.querySelector('.select-overlay');
                    const checkmark = card.querySelector('.absolute.top-3');
                    
                    if (AppState.selectedModules.includes(moduleId)) {
                        if (overlay) overlay.classList.remove('hidden');
                        if (checkmark) checkmark.classList.remove('hidden');
                    } else {
                        if (overlay) overlay.classList.add('hidden');
                        if (checkmark) checkmark.classList.add('hidden');
                    }
                }
                
                this.updateSelectedCount();
            },
            
            // 更新选中数量
            updateSelectedCount() {
                document.getElementById('selected-count').textContent = AppState.selectedModules.length;
            },
            
            // 渲染模块列表
            renderModules() {
                const container = document.getElementById('modules-container');
                // 保留添加按钮
                const addButton = document.getElementById('add-module-card');
                container.innerHTML = '';
                container.appendChild(addButton);
                
                AppState.data.modules.forEach(module => {
                    const moduleCard = document.createElement('div');
                    moduleCard.className = 'module-card rounded-xl overflow-hidden card-shadow cursor-pointer hover:scale-[1.02] transition-smooth relative bg-white';
                    moduleCard.setAttribute('data-id', module.id);
                    
                    moduleCard.innerHTML = `
                        <div class="h-32 bg-gray-100 relative overflow-hidden">
                            ${module.imageUrl ? 
                                `<img src="${module.imageUrl}" alt="${module.name}" class="w-full h-full object-cover">` : 
                                `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fa fa-cube text-4xl"></i>
                                </div>`
                            }
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-gray-800 truncate">${module.name}</h3>
                            <p class="text-xs text-gray-500 mt-1">${module.sections?.length || 0}个版块</p>
                        </div>
                    `;
                    
                    moduleCard.addEventListener('click', () => {
                        if (AppState.isManagingModules) {
                            this.toggleModuleSelection(module.id);
                        } else {
                            AppState.currentModule = module;
                            document.getElementById('detail-module-name').textContent = module.name;
                            this.renderSections();
                            this.showPage('detail-page');
                        }
                    });
                    
                    container.appendChild(moduleCard);
                });
            },
            
            // 渲染大版块
            renderSections() {
                const container = document.getElementById('sections-container');
                container.innerHTML = '';
                
                if (!AppState.currentModule || !AppState.currentModule.sections) return;
                
                AppState.currentModule.sections.forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'bg-section rounded-xl overflow-hidden card-shadow';
                    sectionEl.setAttribute('data-id', section.id);
                    
                    // 版块标题
                    const header = document.createElement('div');
                    header.className = 'p-4 flex justify-between items-center';
                    header.innerHTML = `
                        <h3 class="font-medium text-gray-800">${section.name}</h3>
                        ${AppState.isEditMode ? `
                            <div class="flex space-x-3">
                                <button class="edit-section text-gray-500 hover:text-primary" data-id="${section.id}">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="delete-section text-gray-500 hover:text-red-500" data-id="${section.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    `;
                    sectionEl.appendChild(header);
                    
                    // 产品列表
                    const productsContainer = document.createElement('div');
                    productsContainer.className = 'px-4 pb-4';
                    
                    if (section.products && section.products.length > 0) {
                        const productsList = document.createElement('ul');
                        productsList.className = 'space-y-3 mb-4';
                        productsList.id = `products-list-${section.id}`;
                        
                        section.products.forEach(product => {
                            const productItem = document.createElement('li');
                            productItem.className = 'bg-product rounded-lg p-4 flex justify-between items-center cursor-pointer hover:opacity-90 transition-smooth';
                            productItem.setAttribute('data-id', product.id);
                            
                            productItem.innerHTML = `
                                <span class="product-name font-medium">${product.name}</span>
                                ${AppState.isEditMode ? `
                                    <div class="flex space-x-3">
                                        <button class="edit-product text-gray-500 hover:text-primary" data-id="${product.id}">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="delete-product text-gray-500 hover:text-red-500" data-id="${product.id}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            `;
                            
                            productItem.addEventListener('click', (e) => {
                                if (!e.target.closest('button') && AppState.isEditMode) {
                                    AppState.currentSection = section;
                                    AppState.currentProduct = product;
                                    this.openProductEditPage(product);
                                }
                            });
                            
                            productsList.appendChild(productItem);
                        });
                        
                        productsContainer.appendChild(productsList);
                        
                        // 初始化拖拽排序
                        if (AppState.isEditMode) {
                            new Sortable(productsList, {
                                animation: 150,
                                handle: '.product-name',
                                onEnd: () => {
                                    const productIds = Array.from(productsList.children)
                                        .map(child => parseInt(child.getAttribute('data-id')));
                                    
                                    // 重新排序产品
                                    const sortedProducts = productIds.map(id => 
                                        section.products.find(p => p.id === id)
                                    ).filter(p => p);
                                    
                                    section.products = sortedProducts;
                                    DataManager.autoSave();
                                }
                            });
                        }
                    }
                    
                    // 添加产品按钮
                    if (AppState.isEditMode && (!section.products || section.products.length < 20)) {
                        const addProductBtn = document.createElement('button');
                        addProductBtn.className = 'add-product-btn w-full py-3 text-center text-primary text-sm border border-dashed border-primary/50 rounded-lg hover:bg-primary/5 transition-smooth';
                        addProductBtn.setAttribute('data-section-id', section.id);
                        addProductBtn.innerHTML = '<i class="fa fa-plus mr-2"></i>新增产品名称';
                        productsContainer.appendChild(addProductBtn);
                    }
                    
                    sectionEl.appendChild(productsContainer);
                    container.appendChild(sectionEl);
                });
                
                // 添加大版块按钮
                if (AppState.isEditMode) {
                    const addSectionBtn = document.createElement('button');
                    addSectionBtn.className = 'w-full py-4 text-center text-primary border-2 border-dashed border-primary/50 rounded-xl hover:bg-primary/5 transition-smooth mt-6';
                    addSectionBtn.innerHTML = '<i class="fa fa-plus mr-2"></i>新增大版块';
                    addSectionBtn.id = 'add-section-bottom';
                    container.appendChild(addSectionBtn);
                }
                
                this.bindSectionEvents();
            },
            
            // 打开产品编辑页面
            openProductEditPage(product) {
                AppState.currentProduct = product;
                document.getElementById('edit-product-name').textContent = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-description').readOnly = !AppState.isEditMode;
                this.renderProductImages();
                this.updateLastModified(product.lastModified);
                this.showPage('product-edit-page');
            },
            
            // 渲染产品图片
            renderProductImages() {
                if (!AppState.currentProduct) return;
                
                // 初始化图片数据
                if (!AppState.currentProduct.detailImages) {
                    AppState.currentProduct.detailImages = [];
                }
                if (!AppState.currentProduct.galleryImages) {
                    AppState.currentProduct.galleryImages = [];
                }
                
                // 更新计数
                document.getElementById('detail-image-count').textContent = 
                    `${AppState.currentProduct.detailImages.length}/3`;
                document.getElementById('gallery-image-count').textContent = 
                    `${AppState.currentProduct.galleryImages.length}/6`;
                
                // 渲染细节图片
                const detailContainer = document.getElementById('detail-images-container');
                const addDetailBtn = document.getElementById('add-detail-image-btn');
                detailContainer.innerHTML = '';
                
                AppState.currentProduct.detailImages.forEach((image, index) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'relative group';
                    imgWrapper.innerHTML = `
                        <img src="${image.url}" alt="细节图片" 
                             class="w-full h-28 object-cover rounded-lg cursor-pointer ${AppState.isEditMode ? '' : 'cursor-zoom-in'}"
                             data-group="detail" data-index="${index}">
                        ${AppState.isEditMode ? `
                            <button class="delete-detail-image absolute top-2 right-2 bg-black/70 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-smooth"
                                    data-index="${index}">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        ` : ''}
                    `;
                    detailContainer.appendChild(imgWrapper);
                });
                
                if (AppState.isEditMode && AppState.currentProduct.detailImages.length < 3) {
                    detailContainer.appendChild(addDetailBtn);
                }
                
                // 渲染图片展示
                const galleryContainer = document.getElementById('gallery-images-container');
                const addGalleryBtn = document.getElementById('add-gallery-image-btn');
                galleryContainer.innerHTML = '';
                
                AppState.currentProduct.galleryImages.forEach((image, index) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'relative group';
                    imgWrapper.innerHTML = `
                        <img src="${image.url}" alt="产品图片" 
                             class="w-full h-32 object-cover rounded-lg cursor-pointer ${AppState.isEditMode ? '' : 'cursor-zoom-in'}"
                             data-group="gallery" data-index="${index}">
                        ${AppState.isEditMode ? `
                            <button class="delete-gallery-image absolute top-2 right-2 bg-black/70 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-smooth"
                                    data-index="${index}">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        ` : ''}
                    `;
                    galleryContainer.appendChild(imgWrapper);
                });
                
                if (AppState.isEditMode && AppState.currentProduct.galleryImages.length < 6) {
                    galleryContainer.appendChild(addGalleryBtn);
                }
                
                // 初始化拖拽排序
                if (AppState.isEditMode) {
                    new Sortable(detailContainer, {
                        animation: 150,
                        draggable: '.group',
                        filter: '#add-detail-image-btn',
                        onEnd: () => {
                            const images = Array.from(detailContainer.querySelectorAll('img[data-index]'))
                                .map(img => AppState.currentProduct.detailImages[parseInt(img.dataset.index)]);
                            AppState.currentProduct.detailImages = images;
                            this.renderProductImages();
                            DataManager.autoSave();
                        }
                    });
                    
                    new Sortable(galleryContainer, {
                        animation: 150,
                        draggable: '.group',
                        filter: '#add-gallery-image-btn',
                        onEnd: () => {
                            const images = Array.from(galleryContainer.querySelectorAll('img[data-index]'))
                                .map(img => AppState.currentProduct.galleryImages[parseInt(img.dataset.index)]);
                            AppState.currentProduct.galleryImages = images;
                            this.renderProductImages();
                            DataManager.autoSave();
                        }
                    });
                }
                
                // 绑定图片点击事件
                document.querySelectorAll('#detail-images-container img, #gallery-images-container img').forEach(img => {
                    if (!img.closest('#add-detail-image-btn') && !img.closest('#add-gallery-image-btn')) {
                        img.addEventListener('click', () => {
                            const group = img.dataset.group;
                            const index = parseInt(img.dataset.index);
                            this.openImageViewer(group, index);
                        });
                    }
                });
                
                // 绑定删除事件
                if (AppState.isEditMode) {
                    document.querySelectorAll('.delete-detail-image').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const index = parseInt(btn.dataset.index);
                            AppState.currentProduct.detailImages.splice(index, 1);
                            this.renderProductImages();
                            this.updateLastModified();
                            DataManager.autoSave();
                        });
                    });
                    
                    document.querySelectorAll('.delete-gallery-image').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const index = parseInt(btn.dataset.index);
                            AppState.currentProduct.galleryImages.splice(index, 1);
                            this.renderProductImages();
                            this.updateLastModified();
                            DataManager.autoSave();
                        });
                    });
                }
            },
            
            // 打开图片查看器
            openImageViewer(group, index) {
                AppState.currentImageGroup = group;
                AppState.currentImageIndex = index;
                
                const images = group === 'detail' 
                    ? AppState.currentProduct.detailImages 
                    : AppState.currentProduct.galleryImages;
                
                if (!images || images.length === 0) return;
                
                const viewer = document.getElementById('image-viewer');
                const currentImage = document.getElementById('current-image');
                const counter = document.getElementById('image-counter');
                
                currentImage.src = images[index].url;
                counter.textContent = `${index + 1}/${images.length}`;
                
                viewer.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },
            
            // 更新最后修改时间
            updateLastModified(timestamp) {
                if (!AppState.currentProduct) return;
                
                const now = new Date();
                const lastModified = timestamp ? new Date(timestamp) : now;
                AppState.currentProduct.lastModified = lastModified.toISOString();
                
                const diffMs = now - lastModified;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                let text = '修改于';
                if (diffMins < 1) {
                    text += '刚刚';
                } else if (diffHours < 1) {
                    text += `${diffMins}分钟前`;
                } else if (diffDays < 1) {
                    text += `${diffHours}小时前`;
                } else {
                    text += `${diffDays}天前`;
                }
                
                document.getElementById('last-modified').textContent = text;
                DataManager.autoSave();
            },
            
            // 绑定版块事件
            bindSectionEvents() {
                if (!AppState.isEditMode) return;
                
                // 编辑版块
                document.querySelectorAll('.edit-section').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const sectionId = parseInt(btn.dataset.id);
                        const section = AppState.currentModule.sections.find(s => s.id === sectionId);
                        if (section) {
                            AppState.currentSection = section;
                            document.getElementById('section-name').value = section.name;
                            document.getElementById('section-modal-title').textContent = '编辑大版块';
                            UIManager.showModal('section-modal');
                        }
                    });
                });
                
                // 删除版块
                document.querySelectorAll('.delete-section').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const sectionId = parseInt(btn.dataset.id);
                        const section = AppState.currentModule.sections.find(s => s.id === sectionId);
                        if (section) {
                            AppState.currentSection = section;
                            document.getElementById('delete-confirmation-text').textContent = 
                                `您确定要删除"${section.name}"版块吗？此操作将删除该版块下的所有产品，且无法撤销。`;
                            UIManager.showModal('confirm-delete-modal');
                        }
                    });
                });
                
                // 添加产品
                document.querySelectorAll('.add-product-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const sectionId = parseInt(btn.dataset.sectionId);
                        const section = AppState.currentModule.sections.find(s => s.id === sectionId);
                        if (section) {
                            AppState.currentSection = section;
                            document.getElementById('product-name').value = '';
                            document.getElementById('product-modal-title').textContent = '添加产品';
                            UIManager.showModal('product-modal');
                        }
                    });
                });
                
                // 编辑产品
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = parseInt(btn.dataset.id);
                        const product = AppState.currentSection?.products?.find(p => p.id === productId);
                        if (product) {
                            AppState.currentProduct = product;
                            document.getElementById('product-name').value = product.name;
                            document.getElementById('product-modal-title').textContent = '编辑产品';
                            UIManager.showModal('product-modal');
                        }
                    });
                });
                
                // 删除产品
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = parseInt(btn.dataset.id);
                        const product = AppState.currentSection?.products?.find(p => p.id === productId);
                        if (product) {
                            AppState.currentProduct = product;
                            document.getElementById('delete-confirmation-text').textContent = 
                                `您确定要删除"${product.name}"吗？此操作无法撤销。`;
                            UIManager.showModal('confirm-delete-modal');
                        }
                    });
                });
                
                // 底部添加大版块按钮
                const bottomBtn = document.getElementById('add-section-bottom');
                if (bottomBtn) {
                    bottomBtn.addEventListener('click', () => {
                        document.getElementById('section-name').value = '';
                        document.getElementById('section-modal-title').textContent = '添加大版块';
                        UIManager.showModal('section-modal');
                    });
                }
            }
        };
        
        // ==================== 工具函数 ====================
        const Utils = {
            // 生成唯一ID
            generateId() {
                return AppState.data.nextId++;
            },
            
            // 压缩图片
            compressImage(file, maxSizeMB = 1) {
                return new Promise((resolve) => {
                    const maxSizeBytes = maxSizeMB * 1024 * 1024;
                    
                    if (file.size <= maxSizeBytes) {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                        return;
                    }
                    
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        
                        // 计算压缩比例
                        const ratio = Math.sqrt(maxSizeBytes / file.size);
                        width *= ratio;
                        height *= ratio;
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(blob);
                        }, file.type || 'image/jpeg', 0.8);
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            },
            
            // 显示错误提示
            showError(message) {
                const errorDiv = document.getElementById('login-error');
                const errorMsg = document.getElementById('error-message');
                
                errorMsg.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            },
            
            // 显示成功提示
            showSuccess(message) {
                // 可以添加成功提示样式
                console.log('Success:', message);
            }
        };
        
        // ==================== 事件绑定 ====================
        function initEventListeners() {
            // 登录/注册
            document.getElementById('login-btn').addEventListener('click', async () => {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    Utils.showError('请输入昵称和密码');
                    return;
                }
                
                const user = await AuthSystem.login(username, password);
                if (!user) {
                    Utils.showError('密码错误，请重新输入');
                    return;
                }
                
                AppState.currentUser = user;
                AppState.isEditMode = true;
                await DataManager.loadData(username);
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                UIManager.renderModules();
            });
            
            // 查看模式
            document.getElementById('view-mode-btn').addEventListener('click', async () => {
                const username = document.getElementById('username').value.trim();
                
                if (!username) {
                    Utils.showError('请输入昵称');
                    return;
                }
                
                AppState.currentUser = { username };
                AppState.isEditMode = false;
                await DataManager.loadData(username);
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                UIManager.renderModules();
            });
            
            // 登出
            document.getElementById('logout-btn').addEventListener('click', () => {
                AuthSystem.logout();
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            });
            
            // 模块管理
            document.getElementById('manage-modules').addEventListener('click', () => {
                if (AppState.isEditMode) {
                    if (AppState.isManagingModules) {
                        UIManager.exitModuleManagementMode();
                    } else {
                        UIManager.enterModuleManagementMode();
                    }
                }
            });
            
            // 取消管理模式
            document.getElementById('cancel-management').addEventListener('click', () => {
                UIManager.exitModuleManagementMode();
            });
            
            // 删除选中模块
            document.getElementById('delete-selected').addEventListener('click', () => {
                if (AppState.selectedModules.length > 0) {
                    document.getElementById('delete-confirmation-text').textContent = 
                        `您确定要删除选中的${AppState.selectedModules.length}个模块吗？此操作无法撤销。`;
                    UIManager.showModal('confirm-delete-modal');
                }
            });
            
            // 添加模块
            document.getElementById('add-module-card').addEventListener('click', () => {
                if (!AppState.isEditMode) return;
                
                document.getElementById('module-name').value = '';
                const preview = document.getElementById('module-preview');
                preview.src = '';
                preview.classList.add('hidden');
                UIManager.showModal('module-modal');
            });
            
            // 模块图片上传
            document.getElementById('module-upload-area').addEventListener('click', () => {
                document.getElementById('module-image-upload').click();
            });
            
            document.getElementById('module-image-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressedDataUrl = await Utils.compressImage(file);
                    const preview = document.getElementById('module-preview');
                    preview.src = compressedDataUrl;
                    preview.classList.remove('hidden');
                }
            });
            
            // 保存模块
            document.getElementById('save-module').addEventListener('click', () => {
                const name = document.getElementById('module-name').value.trim();
                if (!name) return;
                
                const newModule = {
                    id: Utils.generateId(),
                    name,
                    imageUrl: document.getElementById('module-preview').src || '',
                    sections: []
                };
                
                AppState.data.modules.push(newModule);
                UIManager.renderModules();
                UIManager.hideAllModals();
                DataManager.autoSave();
            });
            
            // 保存版块
            document.getElementById('save-section').addEventListener('click', () => {
                const name = document.getElementById('section-name').value.trim();
                if (!name || !AppState.currentModule) return;
                
                if (AppState.currentSection) {
                    // 编辑
                    AppState.currentSection.name = name;
                } else {
                    // 新增
                    const newSection = {
                        id: Utils.generateId(),
                        name,
                        products: []
                    };
                    if (!AppState.currentModule.sections) {
                        AppState.currentModule.sections = [];
                    }
                    AppState.currentModule.sections.push(newSection);
                }
                
                UIManager.renderSections();
                AppState.currentSection = null;
                UIManager.hideAllModals();
                DataManager.autoSave();
            });
            
            // 保存产品
            document.getElementById('save-product').addEventListener('click', () => {
                const name = document.getElementById('product-name').value.trim();
                if (!name || !AppState.currentSection) return;
                
                if (AppState.currentProduct) {
                    // 编辑
                    AppState.currentProduct.name = name;
                } else {
                    // 新增
                    const newProduct = {
                        id: Utils.generateId(),
                        name,
                        description: '',
                        detailImages: [],
                        galleryImages: [],
                        lastModified: new Date().toISOString()
                    };
                    if (!AppState.currentSection.products) {
                        AppState.currentSection.products = [];
                    }
                    AppState.currentSection.products.push(newProduct);
                }
                
                UIManager.renderSections();
                AppState.currentProduct = null;
                UIManager.hideAllModals();
                DataManager.autoSave();
            });
            
            // 确认删除
            document.getElementById('confirm-delete').addEventListener('click', () => {
                if (AppState.selectedModules.length > 0) {
                    // 删除模块
                    AppState.data.modules = AppState.data.modules.filter(
                        m => !AppState.selectedModules.includes(m.id)
                    );
                    UIManager.exitModuleManagementMode();
                    UIManager.renderModules();
                } else if (AppState.currentProduct && AppState.currentSection) {
                    // 删除产品
                    AppState.currentSection.products = AppState.currentSection.products.filter(
                        p => p.id !== AppState.currentProduct.id
                    );
                    AppState.currentProduct = null;
                    UIManager.showPage('detail-page');
                } else if (AppState.currentSection && AppState.currentModule) {
                    // 删除版块
                    AppState.currentModule.sections = AppState.currentModule.sections.filter(
                        s => s.id !== AppState.currentSection.id
                    );
                    AppState.currentSection = null;
                    UIManager.renderSections();
                }
                
                UIManager.hideAllModals();
                DataManager.autoSave();
            });
            
            // 取消删除
            document.getElementById('cancel-delete').addEventListener('click', () => {
                AppState.currentProduct = null;
                AppState.currentSection = null;
                UIManager.hideAllModals();
            });
            
            // 导航返回
            document.getElementById('back-to-home').addEventListener('click', () => {
                UIManager.showPage('home-page');
            });
            
            document.getElementById('back-to-detail').addEventListener('click', () => {
                UIManager.showPage('detail-page');
            });
            
            // 添加大版块
            document.getElementById('add-section').addEventListener('click', () => {
                if (!AppState.isEditMode) return;
                document.getElementById('section-name').value = '';
                document.getElementById('section-modal-title').textContent = '添加大版块';
                UIManager.showModal('section-modal');
            });
            
            // 图片上传
            document.getElementById('add-detail-image-btn').addEventListener('click', () => {
                if (!AppState.isEditMode || !AppState.currentProduct) return;
                if (AppState.currentProduct.detailImages.length >= 3) return;
                document.getElementById('detail-image-upload').click();
            });
            
            document.getElementById('add-gallery-image-btn').addEventListener('click', () => {
                if (!AppState.isEditMode || !AppState.currentProduct) return;
                if (AppState.currentProduct.galleryImages.length >= 6) return;
                document.getElementById('gallery-image-upload').click();
            });
            
            // 处理图片上传
            document.getElementById('detail-image-upload').addEventListener('change', async (e) => {
                if (!AppState.currentProduct) return;
                
                const files = Array.from(e.target.files);
                const remaining = 3 - AppState.currentProduct.detailImages.length;
                const filesToUpload = files.slice(0, remaining);
                
                for (const file of filesToUpload) {
                    const compressedDataUrl = await Utils.compressImage(file);
                    AppState.currentProduct.detailImages.push({
                        id: Utils.generateId(),
                        url: compressedDataUrl,
                        originalName: file.name
                    });
                }
                
                UIManager.renderProductImages();
                UIManager.updateLastModified();
                e.target.value = '';
            });
            
            document.getElementById('gallery-image-upload').addEventListener('change', async (e) => {
                if (!AppState.currentProduct) return;
                
                const files = Array.from(e.target.files);
                const remaining = 6 - AppState.currentProduct.galleryImages.length;
                const filesToUpload = files.slice(0, remaining);
                
                for (const file of filesToUpload) {
                    const compressedDataUrl = await Utils.compressImage(file);
                    AppState.currentProduct.galleryImages.push({
                        id: Utils.generateId(),
                        url: compressedDataUrl,
                        originalName: file.name
                    });
                }
                
                UIManager.renderProductImages();
                UIManager.updateLastModified();
                e.target.value = '';
            });
            
            // 保存编辑
            document.getElementById('save-edit').addEventListener('click', () => {
                if (!AppState.isEditMode || !AppState.currentProduct) return;
                
                AppState.currentProduct.description = document.getElementById('product-description').value;
                UIManager.updateLastModified();
                
                const saveBtn = document.getElementById('save-edit');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '已保存';
                saveBtn.classList.add('text-green-500');
                
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('text-green-500');
                }, 1500);
            });
            
            // 图片查看器
            document.getElementById('close-image-viewer').addEventListener('click', () => {
                document.getElementById('image-viewer').classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
            
            document.getElementById('next-image').addEventListener('click', () => {
                const images = AppState.currentImageGroup === 'detail' 
                    ? AppState.currentProduct.detailImages 
                    : AppState.currentProduct.galleryImages;
                
                if (images.length <= 1) return;
                
                AppState.currentImageIndex = (AppState.currentImageIndex + 1) % images.length;
                document.getElementById('current-image').src = images[AppState.currentImageIndex].url;
                document.getElementById('image-counter').textContent = 
                    `${AppState.currentImageIndex + 1}/${images.length}`;
            });
            
            document.getElementById('prev-image').addEventListener('click', () => {
                const images = AppState.currentImageGroup === 'detail' 
                    ? AppState.currentProduct.detailImages 
                    : AppState.currentProduct.galleryImages;
                
                if (images.length <= 1) return;
                
                AppState.currentImageIndex = (AppState.currentImageIndex - 1 + images.length) % images.length;
                document.getElementById('current-image').src = images[AppState.currentImageIndex].url;
                document.getElementById('image-counter').textContent = 
                    `${AppState.currentImageIndex + 1}/${images.length}`;
            });
            
            // 滑动切换图片
            let startX = 0;
            const viewerContainer = document.getElementById('image-viewer-container');
            
            viewerContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });
            
            viewerContainer.addEventListener('touchend', (e) => {
                if (!startX) return;
                
                const endX = e.changedTouches[0].clientX;
                const diffX = endX - startX;
                
                if (diffX > 50) {
                    document.getElementById('prev-image').click();
                } else if (diffX < -50) {
                    document.getElementById('next-image').click();
                }
                
                startX = 0;
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('image-viewer').classList.contains('hidden')) return;
                
                if (e.key === 'Escape') {
                    document.getElementById('close-image-viewer').click();
                } else if (e.key === 'ArrowLeft') {
                    document.getElementById('prev-image').click();
                } else if (e.key === 'ArrowRight') {
                    document.getElementById('next-image').click();
                }
            });
            
            // 取消操作按钮
            document.getElementById('cancel-module').addEventListener('click', () => {
                UIManager.hideAllModals();
            });
            
            document.getElementById('cancel-section').addEventListener('click', () => {
                AppState.currentSection = null;
                UIManager.hideAllModals();
            });
            
            document.getElementById('cancel-product').addEventListener('click', () => {
                AppState.currentProduct = null;
                UIManager.hideAllModals();
            });
            
            // 自动保存描述
            document.getElementById('product-description').addEventListener('input', () => {
                if (AppState.currentProduct && AppState.isEditMode) {
                    AppState.currentProduct.description = document.getElementById('product-description').value;
                    UIManager.updateLastModified();
                }
            });
        }
        
        // ==================== 初始化应用 ====================
        async function initApp() {
            // 检查登录状态
            const user = AuthSystem.checkLoginStatus();
            if (user) {
                AppState.currentUser = user;
                AppState.isEditMode = true;
                await DataManager.loadData(user.username);
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                UIManager.renderModules();
            }
            
            // 初始化事件监听
            initEventListeners();
            
            // 添加示例数据（仅当没有数据时）
            if (AppState.data.modules.length === 0) {
                const sampleModule = {
                    id: Utils.generateId(),
                    name: "示例模块",
                    imageUrl: "https://picsum.photos/300/200?random=1",
                    sections: [
                        {
                            id: Utils.generateId(),
                            name: "示例版块",
                            products: [
                                {
                                    id: Utils.generateId(),
                                    name: "示例产品",
                                    description: "这是一个示例产品的描述内容。",
                                    detailImages: [
                                        {
                                            id: Utils.generateId(),
                                            url: "https://picsum.photos/200/200?random=2",
                                            originalName: "detail1.jpg"
                                        }
                                    ],
                                    galleryImages: [
                                        {
                                            id: Utils.generateId(),
                                            url: "https://picsum.photos/200/200?random=3",
                                            originalName: "gallery1.jpg"
                                        }
                                    ],
                                    lastModified: new Date(Date.now() - 3600000).toISOString()
                                }
                            ]
                        }
                    ]
                };
                
                AppState.data.modules.push(sampleModule);
                DataManager.autoSave();
                UIManager.renderModules();
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>